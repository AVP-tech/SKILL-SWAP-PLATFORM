{% extends "base.html" %}

{% block content %}
<section class="panel">
  <div class="panel-body">
    <div class="section-head">
      <div>
        <div class="eyebrow" style="margin-bottom:10px;">Workflow</div>
        <h2>Your Swap Requests</h2>
        <p class="muted" style="margin-top:6px;">
          Manage the requests you sent and the requests you received.
        </p>
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <a class="btn btn-soft btn-sm" href="{{ url_for('browse_page') }}">Browse Skills</a>
        <a class="btn btn-outline btn-sm" href="{{ url_for('friends_page') }}">Friends</a>
        <button class="btn btn-outline btn-sm" type="button" id="refreshRequestsBtn">Refresh</button>
      </div>
    </div>

    <div id="requestsStatus" class="notice notice-info hidden" role="status" aria-live="polite"></div>
  </div>
</section>

<section class="section">
  <div id="requestsContainer" class="stack" aria-live="polite"></div>
</section>
{% endblock %}

{% block scripts %}
<script>
  const requestsContainer = document.getElementById("requestsContainer");
  const requestsStatus = document.getElementById("requestsStatus");
  const refreshRequestsBtn = document.getElementById("refreshRequestsBtn");

  let isLoadingRequests = false;

  function showRequestsStatus(message, kind = "info") {
    if (!message) {
      requestsStatus.textContent = "";
      requestsStatus.className = "notice notice-info hidden";
      return;
    }
    requestsStatus.textContent = message;
    requestsStatus.className = `notice notice-${kind}`;
  }

  function escapeHtml(value) {
    const div = document.createElement("div");
    div.textContent = value ?? "";
    return div.innerHTML;
  }

  function formatStatus(status) {
    if (!status) return "Pending";
    return status.charAt(0).toUpperCase() + status.slice(1);
  }

  function formatDate(value) {
    if (!value) return "";
    const date = new Date(value);
    if (Number.isNaN(date.getTime())) return "";
    return date.toLocaleString();
  }

  function appendSectionTitle(text) {
    const row = document.createElement("div");
    row.className = "section-head";
    row.style.marginBottom = "0";

    const h = document.createElement("h2");
    h.style.fontSize = "1rem";
    h.textContent = text;

    row.appendChild(h);
    requestsContainer.appendChild(row);
  }

  function appendEmpty(message) {
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `<p class="muted">${escapeHtml(message)}</p>`;
    requestsContainer.appendChild(card);
  }

  function requestCardMarkup(item, type) {
    const other = type === "sent" ? item.target : item.requester;
    const heading = type === "sent"
      ? `Request sent to ${other.name}${other.location ? ` (${other.location})` : ""}`
      : `${other.name}${other.location ? ` (${other.location})` : ""} wants to swap with you`;

    const yourOffered = type === "sent" ? item.requester_offered_skill : item.target_offered_skill;
    const yourWanted = type === "sent" ? item.requester_wanted_skill : item.target_wanted_skill;
    const theirOffered = type === "sent" ? item.target_offered_skill : item.requester_offered_skill;
    const theirWanted = type === "sent" ? item.target_wanted_skill : item.requester_wanted_skill;

    const buttons = [];
    if (item.status === "pending") {
      if (type === "sent") {
        buttons.push('<button class="btn btn-outline btn-sm" data-action="cancelled">Cancel Request</button>');
      } else {
        buttons.push('<button class="btn btn-primary btn-sm" data-action="accepted">Accept</button>');
        buttons.push('<button class="btn btn-danger btn-sm" data-action="rejected">Reject</button>');
      }
    }
    if (item.status === "accepted" && item.connection_id) {
      buttons.push(`<a class="btn btn-soft btn-sm" href="/chat/${item.connection_id}">Open Chat</a>`);
    }

    return `
      <article class="card" data-request-id="${escapeHtml(String(item.id))}">
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start; flex-wrap:wrap;">
          <h3 style="margin-bottom:0;">${escapeHtml(heading)}</h3>
          <span class="status-chip ${escapeHtml(item.status || "pending")}">${escapeHtml(formatStatus(item.status || "pending"))}</span>
        </div>

        <div class="grid grid-2" style="margin-top:10px;">
          <div class="panel-solid" style="border-radius:14px;">
            <div class="panel-body" style="padding:12px;">
              <p class="muted" style="font-size:0.82rem; margin-bottom:6px;">Your side</p>
              <div class="kv">
                <span><strong>Offer:</strong> ${escapeHtml(yourOffered || "-")}</span>
                <span><strong>Want:</strong> ${escapeHtml(yourWanted || "-")}</span>
              </div>
            </div>
          </div>
          <div class="panel-solid" style="border-radius:14px;">
            <div class="panel-body" style="padding:12px;">
              <p class="muted" style="font-size:0.82rem; margin-bottom:6px;">Their side</p>
              <div class="kv">
                <span><strong>Offer:</strong> ${escapeHtml(theirOffered || "-")}</span>
                <span><strong>Want:</strong> ${escapeHtml(theirWanted || "-")}</span>
              </div>
            </div>
          </div>
        </div>

        ${item.created_at ? `<p class="muted" style="font-size:0.82rem; margin-top:10px;">Created: ${escapeHtml(formatDate(item.created_at))}</p>` : ""}

        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:12px;">
          ${buttons.join("")}
        </div>
      </article>
    `;
  }

  function renderSection(title, items, type) {
    appendSectionTitle(title);
    if (!items.length) {
      appendEmpty(type === "sent" ? "No requests sent yet." : "No requests received yet.");
      return;
    }

    items.forEach((item) => {
      requestsContainer.insertAdjacentHTML("beforeend", requestCardMarkup(item, type));
    });
  }

  async function loadRequests() {
    if (isLoadingRequests) return;
    isLoadingRequests = true;
    refreshRequestsBtn.disabled = true;
    refreshRequestsBtn.textContent = "Refreshing...";
    showRequestsStatus("Loading swap requests...", "info");

    try {
      const res = await fetch("/api/swap_requests");
      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        throw new Error(data.message || "Could not load requests.");
      }

      const sent = Array.isArray(data.sent) ? data.sent : [];
      const received = Array.isArray(data.received) ? data.received : [];

      requestsContainer.innerHTML = "";
      renderSection("Requests You Sent", sent, "sent");
      renderSection("Requests You Received", received, "received");
      showRequestsStatus(`Loaded ${sent.length + received.length} request(s).`, "success");
    } catch (err) {
      console.error(err);
      requestsContainer.innerHTML = "";
      appendEmpty("Could not load swap requests right now.");
      showRequestsStatus(err.message || "Could not load swap requests.", "error");
    } finally {
      isLoadingRequests = false;
      refreshRequestsBtn.disabled = false;
      refreshRequestsBtn.textContent = "Refresh";
    }
  }

  async function submitRequestAction(requestId, status, button) {
    const originalText = button.textContent;
    button.disabled = true;
    button.textContent = "Working...";

    try {
      const res = await fetch(`/respond_swap/${requestId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status })
      });

      const data = await res.json().catch(() => ({ message: "Unexpected response from server." }));
      showRequestsStatus(data.message || "Request updated.", res.ok ? "success" : "error");
      if (res.ok) {
        await loadRequests();
        return;
      }
    } catch (err) {
      console.error(err);
      showRequestsStatus("Something went wrong while updating the request.", "error");
    }

    button.disabled = false;
    button.textContent = originalText;
  }

  requestsContainer.addEventListener("click", (event) => {
    const button = event.target.closest("button[data-action]");
    if (!button) return;

    const card = button.closest("[data-request-id]");
    if (!card) return;

    const requestId = card.dataset.requestId;
    const status = button.dataset.action;
    if (!requestId || !status) return;

    submitRequestAction(requestId, status, button);
  });

  refreshRequestsBtn.addEventListener("click", loadRequests);
  window.addEventListener("load", loadRequests);
</script>
{% endblock %}
