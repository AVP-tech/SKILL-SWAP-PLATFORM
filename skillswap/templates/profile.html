{% extends "base.html" %}

{% block content %}
<div class="grid grid-2">
  <section class="panel">
    <div class="panel-body">
      <div class="eyebrow">Your profile</div>
      <h2 style="margin-bottom: 8px;">Set your skill swap preferences</h2>
      <p class="muted">
        Keep this page updated so other users can discover you. Public profiles appear in browse results.
      </p>

      <div class="section">
        <div class="stack">
          <div class="card">
            <h3>Matching tips</h3>
            <p class="muted">Use specific skills like “Python basics” or “Excel dashboards” instead of broad terms.</p>
          </div>
          <div class="card">
            <h3>Availability matters</h3>
            <p class="muted">Users are more likely to respond when your availability and location are filled in clearly.</p>
          </div>
          <div class="card">
            <h3>Next steps</h3>
            <div class="stack">
              <a class="btn btn-soft" href="{{ url_for('browse_page') }}">Browse Public Skills</a>
              <a class="btn btn-outline" href="{{ url_for('swap_requests_page') }}">View Swap Requests</a>
              <a class="btn btn-outline" href="{{ url_for('friends_page') }}">Open Friends</a>
              <a class="btn btn-outline" href="{{ url_for('support_page') }}">Support / Query</a>
            </div>
          </div>
          <div class="card">
            <h3>Engagement ideas</h3>
            <p class="muted">Complete your profile, accept swaps, and start chats to build your learning network faster.</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="panel">
    <div class="panel-body">
      <div class="section-head" style="margin-bottom: 12px;">
        <h2>Edit Profile</h2>
        <span class="pill" id="profileLoadBadge">Loading...</span>
      </div>

      <div id="profileStatus" class="notice notice-info hidden" role="status" aria-live="polite" style="margin-bottom: 12px;"></div>

      <form id="profileForm">
        <div class="field">
          <label for="name">Name</label>
          <input type="text" id="name" name="name" required maxlength="80" />
        </div>

        <div class="field">
          <label for="location">Location</label>
          <input type="text" id="location" name="location" maxlength="100" placeholder="e.g., Delhi, Bangalore" data-suggest-type="location" />
        </div>

        <div class="field">
          <label for="skills_offered">Skills You Offer</label>
          <input type="text" id="skills_offered" name="skills_offered" required maxlength="100" placeholder="e.g., Photoshop, Python basics" data-suggest-type="skill" />
        </div>

        <div class="field">
          <label for="skills_wanted">Skills You Want to Learn</label>
          <input type="text" id="skills_wanted" name="skills_wanted" required maxlength="100" placeholder="e.g., Excel dashboards, Public speaking" data-suggest-type="skill" />
        </div>

        <div class="field">
          <label for="availability">Availability</label>
          <select id="availability" name="availability">
            <option value="weekends">Weekends</option>
            <option value="evenings">Evenings</option>
            <option value="anytime">Anytime</option>
          </select>
        </div>

        <div class="field">
          <label>Profile Visibility</label>
          <div class="radio-row" role="radiogroup" aria-label="Profile visibility">
            <label class="choice">
              <input type="radio" name="visibility" value="public" checked />
              Public
            </label>
            <label class="choice">
              <input type="radio" name="visibility" value="private" />
              Private
            </label>
          </div>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:6px;">
          <button type="submit" class="btn btn-primary" id="saveProfileBtn">Create Profile</button>
          <button type="button" class="btn btn-outline" id="reloadProfileBtn">Reload</button>
        </div>
      </form>
    </div>
  </section>
</div>
{% endblock %}

{% block scripts %}
<script>
  const profileForm = document.getElementById("profileForm");
  const saveProfileBtn = document.getElementById("saveProfileBtn");
  const reloadProfileBtn = document.getElementById("reloadProfileBtn");
  const profileStatus = document.getElementById("profileStatus");
  const profileLoadBadge = document.getElementById("profileLoadBadge");
  let hasProfile = false;

  function showProfileStatus(message, kind = "info") {
    if (!message) {
      profileStatus.textContent = "";
      profileStatus.className = "notice notice-info hidden";
      return;
    }
    profileStatus.textContent = message;
    profileStatus.className = `notice notice-${kind}`;
  }

  function setFormDisabled(disabled) {
    profileForm.querySelectorAll("input, select, button").forEach((el) => {
      el.disabled = disabled;
    });
  }

  function setLoadBadge(text) {
    profileLoadBadge.textContent = text;
  }

  function refreshSaveButtonLabel() {
    saveProfileBtn.textContent = hasProfile ? "Update Profile" : "Create Profile";
  }

  function fillProfile(data) {
    document.getElementById("name").value = data.name || "";
    document.getElementById("location").value = data.location || "";
    document.getElementById("skills_offered").value = data.skills_offered || "";
    document.getElementById("skills_wanted").value = data.skills_wanted || "";
    document.getElementById("availability").value = data.availability || "anytime";

    const visibility = data.visibility === "private" ? "private" : "public";
    const radio = profileForm.querySelector(`input[name="visibility"][value="${visibility}"]`);
    if (radio) radio.checked = true;

    hasProfile = Boolean(data.has_profile);
    refreshSaveButtonLabel();
  }

  async function loadProfile(showLoadingNotice = true) {
    setFormDisabled(true);
    setLoadBadge("Loading...");
    if (showLoadingNotice) showProfileStatus("Loading your profile...", "info");

    try {
      const res = await fetch("/api/get_profile");
      const data = await res.json().catch(() => ({ message: "Could not parse profile response." }));
      if (!res.ok) {
        throw new Error(data.message || "Could not load profile.");
      }
      fillProfile(data);
      setLoadBadge("Ready");
      showProfileStatus("Profile loaded.", "success");
    } catch (err) {
      console.error(err);
      setLoadBadge("Error");
      showProfileStatus(err.message || "Could not load profile details.", "error");
    } finally {
      setFormDisabled(false);
    }
  }

  profileForm.addEventListener("submit", async (event) => {
    event.preventDefault();

    const name = document.getElementById("name").value.trim();
    const location = document.getElementById("location").value.trim();
    const skillsOffered = document.getElementById("skills_offered").value.trim();
    const skillsWanted = document.getElementById("skills_wanted").value.trim();
    const availability = document.getElementById("availability").value;
    const visibility = profileForm.querySelector('input[name="visibility"]:checked')?.value;

    if (!name || !skillsOffered || !skillsWanted || !visibility) {
      showProfileStatus("Please fill all required fields.", "error");
      return;
    }

    saveProfileBtn.disabled = true;
    saveProfileBtn.textContent = "Saving...";
    showProfileStatus("Saving profile changes...", "info");

    try {
      const res = await fetch("/api/update_profile", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          name,
          location,
          skills_offered: skillsOffered,
          skills_wanted: skillsWanted,
          availability,
          visibility
        }),
      });

      const data = await res.json().catch(() => ({ message: "Unexpected response from server." }));
      if (!res.ok) {
        showProfileStatus(data.message || "Could not save profile.", "error");
        if (window.skillSwap?.showToast) window.skillSwap.showToast(data.message || "Could not save profile.", "error");
        return;
      }

      hasProfile = true;
      const action = data.action === "created" ? "created" : "updated";
      const successMessage = action === "created" ? "Profile created successfully" : "Profile updated successfully";
      showProfileStatus(data.message || successMessage, "success");
      if (window.skillSwap?.showToast) window.skillSwap.showToast(successMessage, "success");
      setLoadBadge("Saved");
    } catch (err) {
      console.error(err);
      showProfileStatus("Something went wrong while saving.", "error");
      if (window.skillSwap?.showToast) window.skillSwap.showToast("Something went wrong while saving.", "error");
    } finally {
      saveProfileBtn.disabled = false;
      refreshSaveButtonLabel();
    }
  });

  reloadProfileBtn.addEventListener("click", () => {
    loadProfile(true);
  });

  window.addEventListener("load", () => {
    if (window.skillSwap?.setupAutocompletes) {
      window.skillSwap.setupAutocompletes(profileForm);
    }
    refreshSaveButtonLabel();
    loadProfile(false);
  });
</script>
{% endblock %}
