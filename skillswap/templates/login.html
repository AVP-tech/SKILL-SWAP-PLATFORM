{% extends "base.html" %}

{% block content %}
<section class="auth-wrap">
  <div class="panel auth-card">
    <div class="panel-body">
      <div class="eyebrow">Welcome back</div>
      <h2 style="margin-bottom: 8px;">Login to Skill Swap</h2>
      <p class="muted" style="margin-bottom: 16px;">Access your profile, browse skills, and manage swap requests.</p>

      <div id="loginStatus" class="notice notice-info hidden" role="status" aria-live="polite"></div>

      <form id="loginForm" class="stack" novalidate>
        <div class="field">
          <label for="email">Email</label>
          <input type="email" id="email" name="email" autocomplete="email" required />
        </div>

        <div class="field">
          <label for="password">Password</label>
          <input type="password" id="password" name="password" autocomplete="current-password" required />
        </div>

        <button class="btn btn-primary" type="submit" id="loginBtn">Login</button>
      </form>

      <p class="footer-note">
        Don&apos;t have an account?
        <a href="{{ url_for('register_page') }}" style="color:#0f8a5f;font-weight:700;">Register here</a>
      </p>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
  const loginForm = document.getElementById("loginForm");
  const loginBtn = document.getElementById("loginBtn");
  const loginStatus = document.getElementById("loginStatus");

  function showLoginStatus(message, kind = "info") {
    loginStatus.textContent = message;
    loginStatus.className = `notice notice-${kind}`;
    if (!message) {
      loginStatus.classList.add("hidden");
      return;
    }
  }

  loginForm.addEventListener("submit", async function (event) {
    event.preventDefault();

    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value;

    if (!email || !password) {
      showLoginStatus("Email and password are required.", "error");
      return;
    }

    loginBtn.disabled = true;
    loginBtn.textContent = "Logging in...";
    showLoginStatus("Checking your credentials...", "info");

    try {
      const res = await fetch("/api/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password }),
      });

      const data = await res.json().catch(() => ({ message: "Unexpected response from server." }));
      if (!res.ok) {
        showLoginStatus(data.message || "Login failed.", "error");
        return;
      }

      showLoginStatus(data.message || "Login successful!", "success");
      window.setTimeout(() => {
        window.location.href = "/profile";
      }, 400);
    } catch (err) {
      console.error(err);
      showLoginStatus("Could not reach the server. Please try again.", "error");
    } finally {
      loginBtn.disabled = false;
      loginBtn.textContent = "Login";
    }
  });
</script>
{% endblock %}
