{% extends "base.html" %}

{% block content %}
<section class="panel">
  <div class="panel-body">
    <div class="section-head">
      <div>
        <div class="eyebrow" style="margin-bottom:10px;">Discover people</div>
        <h2>Browse Public Skills</h2>
        <p class="muted" style="margin-top:6px;">Filter public profiles and send a swap request in one click.</p>
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <span class="pill" id="resultCountPill">0 total</span>
        <button class="btn btn-outline btn-sm" id="refreshBrowseBtn" type="button">Refresh</button>
      </div>
    </div>

    <form id="browseFiltersForm" class="stack" style="margin-top: 10px;">
      <div class="field-row">
        <div class="field" style="margin-bottom:0;">
          <label for="searchInput">Search</label>
          <input type="text" id="searchInput" placeholder="Skill or name" data-suggest-type="skill" />
        </div>
        <div class="field" style="margin-bottom:0;">
          <label for="locationInput">Location</label>
          <input type="text" id="locationInput" placeholder="City or area" data-suggest-type="location" />
        </div>
      </div>

      <div class="field-row">
        <div class="field" style="margin-bottom:0;">
          <label for="availabilitySelect">Availability</label>
          <select id="availabilitySelect">
            <option value="">Any</option>
            <option value="weekends">Weekends</option>
            <option value="evenings">Evenings</option>
            <option value="anytime">Anytime</option>
          </select>
        </div>
        <div class="field" style="margin-bottom:0;">
          <label for="perPageSelect">Results per page</label>
          <select id="perPageSelect">
            <option value="6">6</option>
            <option value="12">12</option>
            <option value="18">18</option>
            <option value="24">24</option>
          </select>
        </div>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn btn-primary" type="submit">Apply Filters</button>
        <button class="btn btn-outline" type="button" id="resetBrowseFiltersBtn">Reset</button>
        <a class="btn btn-soft" href="{{ url_for('profile_page') }}">Update My Profile</a>
        <a class="btn btn-outline" href="{{ url_for('friends_page') }}">Friends</a>
        <a class="btn btn-outline" href="{{ url_for('support_page') }}">Support</a>
      </div>
    </form>

    <div id="browseStatus" class="notice notice-info hidden" role="status" aria-live="polite" style="margin-top: 12px;"></div>
  </div>
</section>

<section class="section">
  <div id="cardsContainer" class="grid grid-2" aria-live="polite"></div>
</section>

<section class="section">
  <div class="panel-solid">
    <div class="panel-body" style="display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap;">
      <div class="muted" id="pageMetaText">Page 1 of 1</div>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button class="btn btn-outline btn-sm" type="button" id="prevPageBtn">Previous</button>
        <button class="btn btn-outline btn-sm" type="button" id="nextPageBtn">Next</button>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
  const browseFiltersForm = document.getElementById("browseFiltersForm");
  const searchInput = document.getElementById("searchInput");
  const locationInput = document.getElementById("locationInput");
  const availabilitySelect = document.getElementById("availabilitySelect");
  const perPageSelect = document.getElementById("perPageSelect");
  const resetBrowseFiltersBtn = document.getElementById("resetBrowseFiltersBtn");
  const cardsContainer = document.getElementById("cardsContainer");
  const browseStatus = document.getElementById("browseStatus");
  const refreshBrowseBtn = document.getElementById("refreshBrowseBtn");
  const resultCountPill = document.getElementById("resultCountPill");
  const prevPageBtn = document.getElementById("prevPageBtn");
  const nextPageBtn = document.getElementById("nextPageBtn");
  const pageMetaText = document.getElementById("pageMetaText");

  const state = {
    q: "",
    location: "",
    availability: "",
    page: 1,
    per_page: 6,
  };

  let isLoadingSkills = false;
  let lastPagination = { page: 1, pages: 0, total: 0, has_prev: false, has_next: false };

  function showBrowseStatus(message, kind = "info") {
    if (!message) {
      browseStatus.textContent = "";
      browseStatus.className = "notice notice-info hidden";
      return;
    }
    browseStatus.textContent = message;
    browseStatus.className = `notice notice-${kind}`;
  }

  function escapeHtml(value) {
    const div = document.createElement("div");
    div.textContent = value ?? "";
    return div.innerHTML;
  }

  function setResultCount(total) {
    resultCountPill.textContent = `${total} total`;
  }

  function updatePaginationControls(pagination) {
    lastPagination = pagination || lastPagination;
    const totalPages = Math.max(pagination?.pages || 0, 1);
    const currentPage = pagination?.pages ? pagination.page : 1;

    pageMetaText.textContent = `Page ${currentPage} of ${totalPages}`;
    prevPageBtn.disabled = !(pagination && pagination.has_prev);
    nextPageBtn.disabled = !(pagination && pagination.has_next);
  }

  function createEmptyCard(message) {
    const card = document.createElement("div");
    card.className = "card";
    card.style.gridColumn = "1 / -1";
    card.innerHTML = `<p class="muted">${escapeHtml(message)}</p>`;
    return card;
  }

  function renderCards(items) {
    cardsContainer.innerHTML = "";

    if (!items.length) {
      cardsContainer.appendChild(createEmptyCard("No matching public profiles found."));
      return;
    }

    items.forEach((item) => {
      const card = document.createElement("article");
      card.className = "card";

      const title = document.createElement("h3");
      title.textContent = item.name || `User ${item.user_id}`;

      const meta = document.createElement("p");
      meta.className = "muted";
      const parts = [];
      if (item.location) parts.push(`Location: ${item.location}`);
      if (item.availability) parts.push(`Available: ${item.availability}`);
      meta.textContent = parts.join(" â€¢ ") || "Profile details not shared";

      const offerLine = document.createElement("p");
      offerLine.className = "kv";
      offerLine.innerHTML = `<span><strong>Offers:</strong> ${escapeHtml(item.skill || "-")}</span>`;

      const userIdLine = document.createElement("p");
      userIdLine.className = "muted";
      userIdLine.style.fontSize = "0.82rem";
      userIdLine.textContent = `User ID: ${item.user_id}`;

      const actions = document.createElement("div");
      actions.style.display = "flex";
      actions.style.gap = "8px";
      actions.style.flexWrap = "wrap";
      actions.style.marginTop = "10px";

      const requestBtn = document.createElement("button");
      requestBtn.className = "btn btn-primary btn-sm";
      requestBtn.type = "button";
      requestBtn.textContent = "Request Swap";
      requestBtn.addEventListener("click", () => requestSwap(item.user_id, requestBtn));

      const viewReqBtn = document.createElement("a");
      viewReqBtn.className = "btn btn-outline btn-sm";
      viewReqBtn.href = "{{ url_for('swap_requests_page') }}";
      viewReqBtn.textContent = "Open Requests";

      actions.appendChild(requestBtn);
      actions.appendChild(viewReqBtn);

      card.appendChild(title);
      card.appendChild(meta);
      card.appendChild(offerLine);
      card.appendChild(userIdLine);
      card.appendChild(actions);
      cardsContainer.appendChild(card);
    });
  }

  function buildQueryString() {
    const params = new URLSearchParams();
    if (state.q) params.set("q", state.q);
    if (state.location) params.set("location", state.location);
    if (state.availability) params.set("availability", state.availability);
    params.set("page", String(state.page));
    params.set("per_page", String(state.per_page));
    return params.toString();
  }

  function syncInputsFromState() {
    searchInput.value = state.q;
    locationInput.value = state.location;
    availabilitySelect.value = state.availability;
    perPageSelect.value = String(state.per_page);
  }

  function syncStateFromInputs({ resetPage = false } = {}) {
    state.q = searchInput.value.trim();
    state.location = locationInput.value.trim();
    state.availability = availabilitySelect.value;
    state.per_page = Number.parseInt(perPageSelect.value, 10) || 6;
    if (resetPage) state.page = 1;
  }

  async function loadSkills() {
    if (isLoadingSkills) return;
    isLoadingSkills = true;

    refreshBrowseBtn.disabled = true;
    refreshBrowseBtn.textContent = "Refreshing...";
    prevPageBtn.disabled = true;
    nextPageBtn.disabled = true;
    showBrowseStatus("Loading public profiles...", "info");

    try {
      const res = await fetch(`/skills/offered?${buildQueryString()}`);
      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        throw new Error(data.message || "Failed to load skills.");
      }

      const items = Array.isArray(data.items) ? data.items : [];
      const pagination = data.pagination || { page: 1, pages: 0, total: 0, has_prev: false, has_next: false };

      state.page = pagination.page || 1;
      setResultCount(pagination.total || 0);
      updatePaginationControls(pagination);
      renderCards(items);

      if (!items.length && !(pagination.total > 0)) {
        showBrowseStatus("No public profiles found yet. Ask users to set visibility to public.", "info");
      } else {
        showBrowseStatus(`Loaded ${items.length} profile(s) on this page.`, "success");
      }
    } catch (err) {
      console.error(err);
      cardsContainer.innerHTML = "";
      cardsContainer.appendChild(createEmptyCard("Could not load profiles right now."));
      setResultCount(0);
      updatePaginationControls({ page: 1, pages: 0, has_prev: false, has_next: false });
      showBrowseStatus(err.message || "Could not load profiles.", "error");
    } finally {
      isLoadingSkills = false;
      refreshBrowseBtn.disabled = false;
      refreshBrowseBtn.textContent = "Refresh";
    }
  }

  async function requestSwap(targetId, button) {
    const originalText = button.textContent;
    button.disabled = true;
    button.textContent = "Sending...";

    try {
      const res = await fetch("/swap_request", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ target_id: targetId }),
      });
      const data = await res.json().catch(() => ({ message: "Unexpected error" }));
      showBrowseStatus(data.message || "Request processed.", res.ok ? "success" : "error");
      if (res.ok) {
        button.textContent = "Request Sent";
        button.className = "btn btn-soft btn-sm";
        return;
      }
      button.disabled = false;
      button.textContent = originalText;
    } catch (err) {
      console.error(err);
      showBrowseStatus("Something went wrong while sending the request.", "error");
      button.disabled = false;
      button.textContent = originalText;
    }
  }

  browseFiltersForm.addEventListener("submit", (event) => {
    event.preventDefault();
    syncStateFromInputs({ resetPage: true });
    loadSkills();
  });

  resetBrowseFiltersBtn.addEventListener("click", () => {
    state.q = "";
    state.location = "";
    state.availability = "";
    state.page = 1;
    state.per_page = 6;
    syncInputsFromState();
    loadSkills();
  });

  refreshBrowseBtn.addEventListener("click", () => {
    syncStateFromInputs();
    loadSkills();
  });

  prevPageBtn.addEventListener("click", () => {
    if (!lastPagination.has_prev) return;
    state.page = Math.max(1, state.page - 1);
    loadSkills();
  });

  nextPageBtn.addEventListener("click", () => {
    if (!lastPagination.has_next) return;
    state.page += 1;
    loadSkills();
  });

  perPageSelect.addEventListener("change", () => {
    syncStateFromInputs({ resetPage: true });
    loadSkills();
  });

  window.addEventListener("load", () => {
    if (window.skillSwap?.setupAutocompletes) {
      window.skillSwap.setupAutocompletes(browseFiltersForm);
    }
    syncInputsFromState();
    loadSkills();
  });
</script>
{% endblock %}
